// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  name      String
  password  String
  createdAt DateTime @default(now())

  memberships   OrganizationMembership[]
  swishRequests SwishPaymentRequest[]
}

model Organization {
  id                  Int       @id @default(autoincrement())
  name                String
  logoUrl             String?
  orgNumber           String?
  swishMerchantNumber String?
  swishMode           String? // "TEST" | "PROD"
  swishP12Ciphertext  Bytes?
  swishP12Iv          Bytes?
  swishP12Tag         Bytes?
  swishPassCiphertext Bytes?
  swishPassIv         Bytes?
  swishPassTag        Bytes?
  createdAt           DateTime  @default(now())
  deletedAt           DateTime?

  memberships   OrganizationMembership[]
  accounts      Account[]
  invites       OrganizationInvite[]
  members       Member[]
  swishRequests SwishPaymentRequest[]
}

model OrganizationMembership {
  id             Int       @id @default(autoincrement())
  userId         Int
  organizationId Int
  role           OrgRole   @default(MEMBER)
  createdAt      DateTime  @default(now())
  deletedAt      DateTime?

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([organizationId])
}

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

model OrganizationInvite {
  id             Int       @id @default(autoincrement())
  organizationId Int
  code           String    @unique
  expiresAt      DateTime?
  createdAt      DateTime  @default(now())
  usedAt         DateTime?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model Account {
  id             Int      @id @default(autoincrement())
  name           String
  organizationId Int
  createdAt      DateTime @default(now())

  organization         Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  transactions         Transaction[]
  swishPaymentRequests SwishPaymentRequest[]
}

model Transaction {
  id            Int      @id @default(autoincrement())
  amount        Float
  description   String?
  category      String?
  accountId     Int
  voucherSeries String   @default("A")
  voucherNumber Int
  createdAt     DateTime @default(now())

  account             Account              @relation(fields: [accountId], references: [id], onDelete: Cascade)
  swishPaymentRequest SwishPaymentRequest?

  @@unique([accountId, voucherSeries, voucherNumber]) // Ensure uniqueness per account (simplification, ideally per org)
  @@index([accountId])
}

model Member {
  id             Int       @id @default(autoincrement())
  name           String
  email          String
  phone          String?
  type           String // 'regular', 'youth', 'senior', 'family', etc.
  fee            Float
  paid           Boolean   @default(false)
  organizationId Int
  createdAt      DateTime  @default(now())
  deletedAt      DateTime?

  organization         Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  swishPaymentRequests SwishPaymentRequest[]

  @@index([organizationId])
}

model SwishPaymentRequest {
  id                    String    @id @default(cuid())
  organizationId        Int
  createdByUserId       Int
  memberId              Int?
  payeeAlias            String // Merchant number
  payerAlias            String // Phone number
  amount                String // Keep as string to match Swish API
  currency              String    @default("SEK")
  message               String?
  payeePaymentReference String    @unique
  swishLocation         String?
  status                String    @default("CREATED") // CREATED,PENDING,PAID,DECLINED,ERROR,CANCELLED
  errorCode             String?
  errorMessage          String?
  callbackReceivedAt    DateTime?
  bookAccountId         Int? // Optional account to book transaction to
  transactionId         Int?      @unique // Reference to created transaction (if booked)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    User         @relation(fields: [createdByUserId], references: [id])
  member       Member?      @relation(fields: [memberId], references: [id])
  bookAccount  Account?     @relation(fields: [bookAccountId], references: [id])
  transaction  Transaction? @relation(fields: [transactionId], references: [id])

  @@index([organizationId, createdAt])
  @@index([payeePaymentReference])
}
